- content_for :head do
  %meta{:content => "Transit & Trails : #{@trailhead.name}", :property => "og:title"}/
  %script{:src => "http://www.google.com/jsapi?key=ABQIAAAAO7OoKKBX03U3SrObYGQy0xTR3gcj-N9Qq4sdgfDbE45YeC9R7BTliGpItl3amRLTjNsmtJj-_SOQkw", :type => "text/javascript"}
  :javascript
    google.load("maps", "2.x");
  %script{:src => "http://gmaps-utility-library.googlecode.com/svn/trunk/markermanager/release/src/markermanager.js"}
  / load Galleria
  %script{:src => "/assets/legacy/galleria/galleria-1.2.7.min.js"}
  %script{:src => "/assets/legacy/gzoom.js", :type => "text/javascript"}
  = javascript_include_tag "legacy/common"
  = stylesheet_link_tag "legacy/reset"
  = stylesheet_link_tag "legacy/common"
  = stylesheet_link_tag "legacy/style"
  = stylesheet_link_tag "legacy/trailhead_detail"

#trail-details.trail-details-overlay
  != @trailhead.description

/ begin lightboxed images
- @trailhead.photos.each_with_index do |photo,i|
  .overlay{:id => "photo#{i}"}
    %div
      %a{:href => "http://flickr.com/photos/transitandtrails/#{photo.flickr_id}", :target => "_blank"}
        %img.thumbnail{:src => "#{photo.flickr_medium_url}"}/
/ end lightboxed images

#page.trip-details
  #details-section
    #plan.alt.trailhead
      #page-head
        %h2 Trailhead
        %a{:href => "/"} Back to Map
      / e: page head
      #trip-meta
        / begin share widgets
        .trailhead-social-buttons
          .share-widget
            %a.twitter-share-button{"data-count" => "none", "data-url" => "#{trailhead_path(@trailhead)}", "data-via" => "transitandtrail", :href => "https://twitter.com/share"} Tweet
            %script{:src => "//platform.twitter.com/widgets.js", :type => "text/javascript"}
          .share-widget
            %iframe{:allowTransparency => "true", :frameborder => "0", :scrolling => "no", :src => "//www.facebook.com/plugins/like.php?href=http%3A%2F%2Fwww.transitandtrails.org%2Ftrailheads%2F#{@trailhead.id}&send=false&layout=button_count&width=450&show_faces=false&action=like&colorscheme=light&font&height=80&appId=173296509398219", :style => "border:none; overflow:hidden; width:52px; height:21px;"}
        / end share widgets
        .header
          %h2 #{@trailhead.name}
          %img.type-flag{:alt => "", :src => "/assets/trailhead.png"}/
          - if @trailhead.default_park
            %em
            %a{:href => "#{park_path(@trailhead.default_park)}"} #{@trailhead.default_park.name}
        / b:details
        #trailhead-details
          - if @trailhead.description
            .description
              != truncate_html(@trailhead.description, :length=> 300,  :omission => '...<br/><a class="trail-details-modal" rel="#trail-details" >Read more...</a>')
            / e: entry
          - else
            %div{:style => "height:10px"}

          = render :partial => "/shared/partials/features", :locals => {:object=>@trailhead}

          .button-frame
            - if can?(:edit,:trailhead)
              %a.gray-link-button.left{:href => "#{edit_trailhead_path(@trailhead)}"} Edit Trailhead

            %a.green-link-button.right.padded-sides{:href => "/plan/trailhead/#{@trailhead.id}"}
              Plan Trip to Here

          - if can?(:destroy,:trailhead)
            .button-frame
              = link_to("Delete Trailhead", @trailhead, :method => :delete, :confirm => "Are you sure?", :class=>"green-link-button right padded")

          - if @trailhead.maps.count > 0
            %div{:style => "clear:both"}
            #download-maps
              - @trailhead.maps.each do |map|
                .map
                  - if map.map
                    %a.get-map{:href => "#{map.map}", :target => "_blank"}
                      .download-icon
                      .download-text
                        Download Map
                        %span.down-caret ▼
                  - elsif map.map_url
                    %a.get-map{:href => "#{map.map_url}", :target => "_blank"}
                      .download-icon
                      .download-text
                        Download Map
                        %span.down-caret ▼
                  - if can?(:destroy, :map)
                    %a.delete{:href => "/trailheads/delete_map/#{map.id}/"} [Delete Map]

          - if can?(:create, :map)
            %label.text-attr-label
              Add Map
            %form
              %input{:checked => "checked", :name => "map-select", :type => "radio", :value => "file"}>/
              File
              %br/
              %input{:name => "map-select", :type => "radio", :value => "url"}/
              Map
              %br/
            %form#map-file-form{:action => "/trailheads/map_upload/", :enctype => "multipart/form-data", :method => "POST"}
              %input#map{:name => "map", :type => "file"}/
              %input#map_url{:name => "url", :style => "display:none;", :type => "text"}/
              %input{:name => "mapable_id", :type => "hidden", :value => "#{@trailhead.id}"}/
              %input{:name => "mapable_type", :type => "hidden", :value => "Trailhead"}/
              %input#map-save-button.green-link-button{:type => "submit", :value => "Upload"}/

        - if @trailhead.agency
          .agency
            .logo
              - if @trailhead.agency.logo && @trailhead.agency.link
                %a{:href => "#{@trailhead.agency.link}", :target => "_blank"}
                  %img{:src => "#{@trailhead.agency.logo}"}/
              - elsif @trailhead.agency.logo
                %img{:src => "#{@trailhead.agency.logo}"}/
            .text
              Managed by
              .name
                - if @trailhead.agency.link
                  %a{:href => "#{@trailhead.agency.link}", :target => "_blank"}
                    #{@trailhead.agency.name}
                - else
                  #{@trailhead.agency.name}

        - regional_trails = @trailhead.trailhead_features.where(:category_id=>Category.where(:name=>"Regional Trail"))
        - regional_trails.each do |feature|
          - klass = feature == regional_trails.last ? "agency last" : "agency"
          .if.endif{:class => "#{klass}"}
            .logo
              - if feature.marker_icon
                - if feature.link_url
                  %a{:href => "#{feature.link_url}", :target => "_blank"}
                    %img{:src => "#{feature.marker_icon.url}"}/
                - else
                  %img{:src => "#{feature.marker_icon.url}"}/
            .text
              This trail is part of the
              .name
                - if feature.link_url
                  %a{:href => "#{feature.link_url}", :target => "_blank"}
                    #{ feature.name }
                - else
                  #{feature.name}

      / end Regional Trails
      / begin Non-profit Partner
      - if @trailhead.default_park && @trailhead.default_park.non_profit_partner
        .agency.non-profit-partner
          .logo
            - if @trailhead.default_park.non_profit_partner.logo
              - if @trailhead.default_park.non_profit_partner.link
                %a{:href => "#{@trailhead.default_park.non_profit_partner.link}", :target => "_blank"}
                  %img{:src => "#{@trailhead.default_park.non_profit_partner.logo }"}/
              - else
                %img{:src => "#{@trailhead.default_park.non_profit_partner.logo }"}/
          .text
            NONPROFIT PARTNER: 
            .name
              - if @trailhead.default_park.non_profit_partner.link
                %a{:href => "#{@trailhead.default_park.non_profit_partner.link}", :target => "_blank"}
                  #{@trailhead.default_park.non_profit_partner}
              - else
                #{@trailhead.default_park.non_profit_partner }
        / end Non-profit Partner
    / e:plan
    #trailhead-stories
      .section-head
        %h2 Stories
      / e: page head
      #story-items
        .story-button
          %a.green-link-button{:href => "#{polymorphic_path([:new,@trailhead,:story])}"} Add Your Story
          .clearfix  
        - @trailhead.stories.each do |story|
          .story-item
            .story-author
              %b #{ story.author.username }
            .story-text
              #{ story.story }
            .story-travel-modes
              %b #{ story.happened_at }
              via
              %b #{ story.travel_mode_to.name }}
              - if story.travel_mode_from != story.travel_mode_to
                and
                %b #{ story.travel_mode_from.name }
  #trailhead-photos-map
    - if can?(:create,:trailhead_photo)
      .section-head
        %h2 Photos
      .trailhead-photo-admin
        %a.prev.browse.left
        #photos.scrollable
          .items
            - @trailhead.photos.each_with_index do |photo,i|
              .photo
                = link_to('', photo, :method => :delete, :class=>'close')
                = image_tag(photo.flickr_square_url, :rel => "#photo#{i}", :class=>"thumbnail")
        %a.next.browse.right
        - if @trailhead.photos.count > 5
          %div{:style => "clear:both"}
          %div{:style => "text-align:right;display:inline-block;float:right;position:relative;top:-20px;"}
            %a{:href => "http://flickr.com/photos/transitandtrails/tags/trailheadid#{@trailhead.id}/"} More...
        #photo-upload
          %label.text-attr-label
            Add Photo
          %form{:action => "/trailheads/#{@trailhead.id}/photos", :enctype => "multipart/form-data", :method => "POST"}
            %input{:name => "photo", :type => "file"}/
            %input{:name => "imageable_id", :type => "hidden", :value => "#{@trailhead.id}"}/
            %input{:name => "imageable_type", :type => "hidden", :value => "Trailhead"}/
            %input.green-map-button{:type => "submit", :value => "Upload"}/
    - else

      - if @trailhead.photos.count > 0
        .section-head
          %h2 Photos
        .trip-photo-admin
          #galleria
            - @trailhead.photos.each do |photo|
              %a{:href => "#{photo.flickr_medium_url}"}
                %img.photo{:src => "#{photo.flickr_medium_url}"}/
          .powered-by powered by flickr
    .section-head
      %h2 Map
    #plan-map.trailhead-details-map
    / #trailhead-comments
    /   .section-head
    /     %h2 Comments
    /   / e: page head
    /   .comments
    /     {% include "base/disqus.html" %}
    / e: comments
  .clearfix  

%script{:src => "/assets/legacy/pointmap.js", :type => "text/javascript"}
%script{:src => "/assets/legacy/jquery/js/jquery.tools.min.js", :type => "text/javascript"}
- if can?(:create,:photo)
  %script
    var can_create_photos = true;
-else
  %script
    var can_create_photos = false;

:javascript
  $(document).ready(function(){
      if(can_create_photos){
        $(".scrollable").scrollable({circular:false});
        $(".photo img[rel]").overlay();
      } else {
        if ($('#galleria').get(0)) {
            Galleria.loadTheme('/assets/legacy/galleria/galleria.classic.min.js');
            // Initialize Galleria
            Galleria.configure({thumbnails:false, imageMargin:0, imageCrop:true});
            Galleria.run('#galleria');

            Galleria.ready(function(){

            });
        }
      }

      $('thumbnail a[rel]').overlay();

      initTrailheadDetails(#{@trailhead.id}, false);

      $(window).unload(function () {
          GUnload();
      });

      $('input:radio[name=map-select]').click(function () {
          if ($('input:radio[name=map-select]:checked').val() == "url") {
              $('#map-save-button').attr('value', "Save");
              $('#map_url').show();
              $('#map').hide();
          } else if ($('input:radio[name=map-select]:checked').val() == "file") {
              $('#map-save-button').attr('value', "Upload");
              $('#map_url').hide();
              $('#map').show();
          }
      });
  });

